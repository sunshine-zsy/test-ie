"use strict";(self["webpackChunkpc_exam_student"]=self["webpackChunkpc_exam_student"]||[]).push([[989],{96989:function(e,t,n){n.r(t),n.d(t,{default:function(){return x}});var a=function(){var e=this,t=e._self._c;return t("div",{staticClass:"login-container"},[e.isCardLogin?t("el-card",{staticClass:"login-card"},[t("el-tabs",{on:{"tab-click":e.handleTabClick},model:{value:e.loginType,callback:function(t){e.loginType=t},expression:"loginType"}},[t("el-card",{staticClass:"exam-info-card"},[t("el-form",{ref:"form",attrs:{model:e.examInfo,"label-width":"100px"}},[t("el-row",[t("el-col",{attrs:{span:12}},[t("el-form-item",{attrs:{label:"考生姓名"}},[t("el-input",{attrs:{disabled:""},model:{value:e.examInfo.username,callback:function(t){e.$set(e.examInfo,"username",t)},expression:"examInfo.username"}})],1)],1),t("el-col",{attrs:{span:12}},[t("el-form-item",{attrs:{label:"身份证号"}},[t("el-input",{attrs:{disabled:""},model:{value:e.examInfo.idcard,callback:function(t){e.$set(e.examInfo,"idcard",t)},expression:"examInfo.idcard"}})],1)],1)],1),t("el-row",[t("el-col",{attrs:{span:12}},[t("el-form-item",{attrs:{label:"考试科目"}},[t("el-input",{attrs:{disabled:""},model:{value:e.examInfo.subject,callback:function(t){e.$set(e.examInfo,"subject",t)},expression:"examInfo.subject"}})],1)],1),t("el-col",{attrs:{span:12}},[t("el-form-item",{attrs:{label:"考试时间"}},[t("el-input",{attrs:{disabled:""},model:{value:e.examInfo.examTime,callback:function(t){e.$set(e.examInfo,"examTime",t)},expression:"examInfo.examTime"}})],1)],1)],1),t("el-form-item",{attrs:{label:"注意事项"}},[t("div",{staticClass:"remark-html",domProps:{innerHTML:e._s(e.examInfo.remark)}})]),t("el-form-item",{staticStyle:{"text-align":"center","margin-right":"15%"}},[t("el-button",{staticClass:"align-center",attrs:{type:"primary",disabled:""==e.examInfo.idcard},on:{click:e.startExam}},[e._v("确认信息进入考试")])],1)],1)],1)],1)],1):e._e()],1)},r=[],o=n(9217),s=n(24634),i=(n(28706),n(44114),n(62010),n(33110),n(79432),n(57381)),c=n(44973),l=n(4917),u=n(47120);function m(e){return(0,u.A)({url:"/exam/computer/getInfoByFingerId/"+e,method:"get"})}var d=n(7114),f={name:"LoginPage",data:function(){return{isCardLogin:!0,examInfo:{username:"",subject:"",examTime:"",idcard:"",remark:""},fingerprint:"",computerInfo:{},loginType:"account",loading:!1,captchaImg:"",accountForm:{username:"",password:"",captcha:"",uuid:""},userAndExamInfo:{},socket:null,reconnectAttempts:0,maxReconnectAttempts:5,reconnectInterval:5e3,accountRules:{username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,message:"密码长度不能小于6位",trigger:"blur"}],captcha:[{required:!0,message:"请输入验证码",trigger:"blur"},{min:1,message:"验证码长度不能小于1位",trigger:"blur"}]}}},methods:{startExam:function(){this.$router.push({name:"ExamPaper",params:{id:this.userAndExamInfo.exam.paperId},query:{examId:this.userAndExamInfo.exam.id,studentId:this.userAndExamInfo.user.userId,title:this.userAndExamInfo.exam.name}})},getBrowserFingerprint:function(){var e=this;l.Ay.load().then(function(t){t.get().then(function(t){console.log("浏览器指纹ID"),console.log(t.visitorId),localStorage.setItem("fingerprint",t.visitorId),e.fingerprint=t.visitorId,e.initWebSocket(),m(t.visitorId).then(function(t){e.computerInfo=t.data})})})},initWebSocket:function(){var e=this;if(this.reconnectAttempts>=this.maxReconnectAttempts)this.$message.error("WebSocket 连接失败，达到最大重试次数");else{console.log("初始化 WebSocket 链接");var t=d.A.WebSocketURL;if(console.log(t,"aaa"),!t)return console.error("未配置 WebSocketURL"),void this.$message.error("未配置 WebSocketURL");this.socket=new WebSocket(t+this.fingerprint),this.socket.addEventListener("open",function(){e.reconnectAttempts=0,e.registerFingerprint()}),this.socket.addEventListener("message",function(t){if(console.log("WebSocket消息："),console.log(t.data),""!=t.data||null!=t.data){var n=JSON.parse(t.data);e.userAndExamInfo=n,localStorage.setItem(e.fingerprint,n);try{localStorage.setItem("token",n.token),e.getUserProfile(n.token)}catch(a){console.error("获取用户信息失败:",a)}e.examInfo.username=n.user.nickName,e.examInfo.subject=n.exam.title,e.examInfo.examTime=n.exam.startTime,e.examInfo.idcard=n.user.idCard,e.examInfo.remark=n.exam.content}}),this.socket.addEventListener("close",function(){e.reconnectAttempts++,e.reconnectAttempts<e.maxReconnectAttempts?(e.$message.warning("WebSocket 连接关闭，".concat(e.reconnectInterval/1e3," 秒后尝试第 ").concat(e.reconnectAttempts+1," 次重连")),setTimeout(function(){e.initWebSocket(),console.log("WebSocket 连接关闭，已达最大重连次数")},e.reconnectInterval)):e.$message.error("WebSocket 连接失败，达到最大重试次数")}),this.socket.addEventListener("error",function(e){console.error("WebSocket 连接出错:",e)})}},getUserProfile:function(e){return(0,s.A)((0,o.A)().m(function t(){var n;return(0,o.A)().w(function(t){while(1)switch(t.n){case 0:return console.info("获取用户信息---------------------"),console.info(e),t.n=1,(0,i.VZ)(e);case 1:n=t.v,console.info("获取用户信息成功"),console.info(n),localStorage.setItem("userInfo",JSON.stringify(n.data));case 2:return t.a(2)}},t)}))()},setExamData:function(){},registerFingerprint:function(){this.socket.readyState===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"online",fingerprint:this.fingerprint}))},getCaptcha:function(){var e=this;return(0,s.A)((0,o.A)().m(function t(){var n,a;return(0,o.A)().w(function(t){while(1)switch(t.p=t.n){case 0:return t.p=0,t.n=1,(0,i.z8)();case 1:n=t.v,n&&n.data&&n.data.img&&n.data.uuid?(e.captchaImg="data:image/gif;base64,".concat(n.data.img),e.accountForm.uuid=n.data.uuid):(e.$message.error("获取验证码失败"),c.A.error("验证码数据异常:",n)),t.n=3;break;case 2:t.p=2,a=t.v,c.A.error("获取验证码失败:",a),e.$message.error(a.message||"获取验证码失败");case 3:return t.a(2)}},t,null,[[0,2]])}))()},refreshCaptcha:function(){this.accountForm.captcha="",this.getCaptcha()},handleTabClick:function(){var e;(this.loading=!1,"account"===this.loginType)&&(null===(e=this.$refs.accountForm)||void 0===e||e.resetFields(),this.refreshCaptcha())},handleAccountLogin:function(){var e=this;return(0,s.A)((0,o.A)().m(function t(){return(0,o.A)().w(function(t){while(1)switch(t.n){case 0:e.$refs.accountForm.validate(function(){var t=(0,s.A)((0,o.A)().m(function t(n){var a,r,s;return(0,o.A)().w(function(t){while(1)switch(t.p=t.n){case 0:if(!n){t.n=6;break}return e.loading=!0,t.p=1,t.n=2,(0,i.iD)({username:e.accountForm.username,password:e.accountForm.password,code:e.accountForm.captcha,uuid:e.accountForm.uuid});case 2:return a=t.v,localStorage.setItem("token",a.data.token),t.n=3,(0,i.Vp)();case 3:r=t.v,localStorage.setItem("userInfo",JSON.stringify(r.data)),e.$message.success("登录成功"),s=e.$route.query.redirect||"/course",e.$router.push(s),t.n=5;break;case 4:t.p=4,t.v,e.refreshCaptcha();case 5:return t.p=5,e.loading=!1,t.f(5);case 6:return t.a(2)}},t,null,[[1,4,5,6]])}));return function(e){return t.apply(this,arguments)}}());case 1:return t.a(2)}},t)}))()}},created:function(){this.getBrowserFingerprint()}},g=f,p=n(81656),h=(0,p.A)(g,a,r,!1,null,"39338a8c",null),x=h.exports}}]);
//# sourceMappingURL=989-legacy.cc00dd94.js.map